# Node.js

# Build a general Node.js project with npm.
# Add steps that analyze code, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/languages/javascript

variables:
  - group: Default Variable Group

trigger:
  - master
  - develop
  - feature/*
  - release/*
  - greenkeeper/*

pool:
  vmImage: 'ubuntu-latest'

jobs:
  - job: buildAndTest
    timeoutInMinutes: 10
    displayName: Build and test
    steps:
      - task: NodeTool@0
        inputs:
          versionSpec: '12.x'
        displayName: 'Install Node.js'
      # - script: yarn install
      #   displayName: 'Yarn install'
      # - script: yarn lint
      #   displayName: 'Yarn Lint'
      # - script: yarn build
      #   displayName: 'Yarn build'
      # - task: DockerCompose@0
      #   displayName: Start the Dev Proxy Image
      #   inputs:
      #     action: Run services
      #     dockerComposeFile: '$(System.DefaultWorkingDirectory)/docker-compose.yml'
      #     projectName: $(Build.Repository.Name)
      #     detached: true
      #     buildImages: true
      # - script: yarn test:cypress
      #   displayName: 'Cypress tests'
      # - task: PublishTestResults@2
      #   displayName: Publish test results
      #   condition: always()
      #   inputs:
      #     testRunner: JUnit
      #     testResultsFiles: '$(System.DefaultWorkingDirectory)/testresults/output.xml'
      # - task: PublishBuildArtifacts@1
      #   displayName: Publish Cypress test artifacts
      #   condition: failed()
      #   inputs:
      #     pathtoPublish: '$(System.DefaultWorkingDirectory)/cypress/videos'
      #     artifactName: cypress_videos

  - deployment: deploy
    displayName: Deploy images
    dependsOn: buildAndTest
    timeoutInMinutes: 10
    environment:
      name: Live
    strategy:
      runOnce:
        deploy:
          steps:
            - checkout: self
            - script: ls -a
            - task: Docker@2
              displayName: Login to Docker
              inputs:
                command: login
                containerRegistry: dockerHubServiceConnection
            - task: Docker@2
              displayName: Build base docker image
              inputs:
                command: buildAndPush
                containerRegistry: dockerHubServiceConnection
                Dockerfile: base.Dockerfile
                repository: furystack/multiverse-base
                tags: latest
            - task: Docker@2
              displayName: Build Auth docker image
              inputs:
                command: buildAndPush
                containerRegistry: dockerHubServiceConnection
                Dockerfile: auth.Dockerfile
                repository: furystack/multiverse-wrap-r
                tags: latest
            - task: Docker@2
              displayName: Build Diag docker image
              inputs:
                command: buildAndPush
                containerRegistry: dockerHubServiceConnection
                Dockerfile: diag.Dockerfile
                repository: furystack/multiverse-diag
                tags: latest
            - task: Docker@2
              displayName: Build Xpense docker image
              inputs:
                command: buildAndPush
                containerRegistry: dockerHubServiceConnection
                Dockerfile: diag.Dockerfile
                repository: furystack/multiverse-xpense
                tags: latest
